#!/bin/sh
### BEGIN INIT INFO
# Provides:          openconnect
# Short-Description: Start/stop NewSpring VPN connection
### END INIT INFO

set -e

VPN_USERNAME="<%= node[:vpn][:username] %>"
VPN_PASSWORD="<%= node[:vpn][:password] %>"
VPN_HOST="<%= node[:vpn][:hostname] %>"

. /lib/lsb/init-functions

PIDFILE="/run/newspring_vpn.pid"
if [ -z "$PIDFILE" ] ; then
	echo ERROR: NEWSPRING VPN PID is not defined for some reason >&2
	exit 2
fi


pidof_newspring_vpn() {
	# if there is actually an apache2 process whose pid is in PIDFILE,
	# print it and return 0.
	if [ -e "$PIDFILE" ]; then
		if pidof openconnect | tr ' ' '\n' | grep -w $(cat $PIDFILE); then
			return 0
		fi
	fi
	return 1
}

newspring_vpn_stop() {
		PID=$(pidof_newspring_vpn) || true

		if [ "${PID}" ]; then
			# in this case it is everything nice and dandy and we kill openconnect
			echo
			log_warning_msg "Killing the NewSpring VPN Connection!"
                        kill $PID
		fi
}

newspring_vpn_start() {
    PID=$(pidof_newspring_vpn) || true

    if [ "${PID}" ]; then
    # in this case it is everything nice and dandy and we kill openconnect
	echo
	log_warning_msg "VPN Already Establised!"
    else
        echo "$VPN_PASSWORD" | openconnect $VPN_HOST --pid-file=$PIDFILE -u $VPN_USERNAME -b --passwd-on-stdin --no-cert-check
	      route add -net 10.0.0.0/8 tun0
    fi
}


case $1 in
	start)
		log_daemon_msg "Connecting to NewSpring VPN!"
		if newspring_vpn_start; then
			 log_end_msg 0
    else
       log_end_msg 1
    fi
	;;
	stop)
		log_daemon_msg "Closing connection to NewSpring VPN!"
		if newspring_vpn_stop; then
			 log_end_msg 0
    else
       log_end_msg 1
    fi
	;;
	restart)
		log_daemon_msg "Closing connection to NewSpring VPN!"
		if newspring_vpn_stop; then
       if newspring_vpn_start; then
			   log_end_msg 0
       fi
    else
       log_end_msg 1
    fi
	;;
	status)
		PID=$(pidof_newspring_vpn) || true
		if [ -n "$PID" ]; then
			echo "NewSpring VPN is running (pid $PID)."
			exit 0
		else
			echo "NewSpring VPN is NOT running."
			if [ -e "$PIDFILE" ]; then
				exit 1
			else
				exit 3
			fi
		fi
	;;
	*)
		log_success_msg "Usage: /etc/init.d/newspring_vpn {start|stop|restart|status}"
		exit 1
	;;
esac

#Dropped here by Chef!
